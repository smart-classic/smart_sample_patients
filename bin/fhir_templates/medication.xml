{%- extends "entry.xml" %}
{%- block content %}
<MedicationPrescription xmlns="http://hl7.org/fhir">
  <text>
    <status value="generated"/>
    <div xmlns="http://www.w3.org/1999/xhtml">
      {{m.name}} (rxnorm: {{m.rxn}})
    </div>
  </text>

  <contained>
    <Medication id="med">
      <name value="{{m.name}}"/>
      <code>
	<coding>
	  <system value="http://rxnav.nlm.nih.gov/REST/rxcui"/>
	  <code value="{{m.rxn}}"/>
	  <display value="{{m.name}}"/>
	</coding>
      </code>
    </Medication>
  </contained>

  <status value="active" />
  <patient>
    <type value="Patient"/>
    <reference value="cid:patient-{{pid}}"/>
  </patient>

  <medication>
    <type value="Medication"/>
    <reference value="#med"/>
  </medication>

  <dosageInstruction>
    <timingSchedule>
      <event>
	<start value="{{m.start}}"/>
	{%- if m.end is defined and m.end != "" %}
	<end value="{{m.end}}"/>
	{%endif%}
      </event>
      {%- if m.freqduration %}
      <repeat>
	<frequency value="{{m.freq}}"/>
	<duration value="1"/>
	<units value="{{m.freqduration}}"/>
      </repeat>
      {% endif %}
    </timingSchedule>
    {%- if m.qtt %}
    <doseQuantity>
      <value value="{{m.qtt}}"/>
      <units value="{{m.qttunit}}"/>
      <system value="http://unitsofmeasure.org"/>
      <code value="{{m.qttunit}}"/>
    </doseQuantity>
    {% endif %}
  </dosageInstruction>
</MedicationPrescription>
{% endblock %}
